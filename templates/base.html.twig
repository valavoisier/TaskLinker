<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>{% block title %}TaskLinker{% endblock %}</title>

    {# Importmap obligatoire pour charger app.js (et donc app.css) #}
    {% block importmap %}
    {{ importmap('app') }}
    {% endblock %}

    {# FontAwesome #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    {# Select2 CSS #}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

</head>

<body>
    <div id="main-container">

        {# MENU FACTORISÉ #}
        {% include 'partials/nav.html.twig' %}
<noscript>Attention! sans javascript ce site ne peut ps fonctionner correctement</noscript>
        <main>

            <header>
                <div id="current-user">
                    {% if app.user %} 
                        <a href="{{ path('app_logout') }}" class="user-avatar"> 
                            {{ app.user.initials }} 
                        </a>
                    {% endif %}
                </div>

                <div id="title-page">
                    <div class="flex-header"> 
                        {# Titre de la page (obligatoire) #} 
                        <h1>{% block page_title %}{% endblock %}</h1> 

                        {# Avatars + bouton Modifier (optionnel/projets) #}
                        {% block page_actions %}{% endblock %}

                        {% for message in app.flashes('error') %} 
                            
                                <div class="alert alert-danger"> 
                                    {{ message }} 
                                </div> 
                             
                        {% endfor %}
                    </div>
                </div>
            </header>

            <div id="content">
                {% block body %}{% endblock %}
            </div>

        </main>
    </div>

    {# jQuery + Select2 #}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    {# JS perso #}
    <script src="{{ asset('js/select.js') }}"></script>

    {# Modal 2FA pour les utilisateurs non configurés #}
    {% if app.user and not app.user.isTwoFactorEnabled() and not app.user.hide2FAPrompt %}
        <div id="modal-2fa-prompt" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2> <i class="fa-solid fa-shield-halved"></i> Sécurisez votre compte</h2>
                </div>
                <div class="modal-body">
                    <p>La <strong>double authentification</strong> ajoute une couche de sécurité supplémentaire à votre compte.</p>
                    <p>Voulez-vous l'activer maintenant ?</p>
                </div>
                <div class="modal-footer">
                    <button onclick="hideModal2FA('later')" class="btn-secondary">Plus tard</button>
                    <button onclick="hideModal2FA('never')" class="btn-text">Ne plus me le demander</button>
                    <a href="{{ path('app_2fa_setup') }}" class="btn-primary">Activer la 2FA</a>
                </div>
            </div>
        </div>
        <script>
            function hideModal2FA(action) {
                const modal = document.getElementById('modal-2fa-prompt');
                modal.style.display = 'none';
                
                if (action === 'never') {
                    // Enregistrer la préférence côté serveur
                    fetch('{{ path('app_2fa_hide_prompt') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest' // Indiquer que c'est AJAX
                        },
                        credentials: 'same-origin', // Inclure les cookies de session
                        redirect: 'manual' // Ne pas suivre les redirections automatiquement
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (response.status === 0 || response.type === 'opaqueredirect') {
                            console.warn('Redirect detected, request may have failed');
                            return null;
                        }
                        if (!response.ok) {
                            console.error('HTTP error:', response.status);
                            return null;
                        }
                        return response.text();
                    })
                    .then(text => {
                        if (!text) return;
                        console.log('Response text:', text);
                        try {
                            const data = JSON.parse(text);
                            console.log('Parsed JSON:', data);
                            if (!data.success) {
                                console.error('Failed to hide prompt:', data);
                            }
                        } catch (e) {
                            console.error('JSON parse error:', e);
                            console.error('Response was:', text.substring(0, 200));
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                }
            }
            
            // Afficher le modal après 2 secondes
            setTimeout(() => {
                document.getElementById('modal-2fa-prompt').style.display = 'flex';
            }, 2000);
        </script>
    {% endif %}

</body>

</html>